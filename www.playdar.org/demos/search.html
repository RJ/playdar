<!--#set var="title" value="Playdar - search demo" --><!--#include virtual="../inc/header.html" -->

<script type="text/javascript" src="/static/soundmanager2-nodebug-jsmin.js"></script>
<script type="text/javascript">
// see if there's a query string in the # part of the url so that 
// we can permalink to a specific search
var parseHash = function () {
    var hash = location.hash;
    if (hash == "" || hash == "#") {
        return;
    }
    var params = hash.substr(1).toQueryParams();
    if (params.artist && params.track) {
        $('artist').value = params.artist;
        $('track').value = params.track;
        $('album').value = params.album ? params.album : "";
        resolve($('artist').value, $('album').value, $('track').value);
    }
};

var playdar = new Playdar({
    stat_complete: function (detected) {
        var text;
        if (detected) {
            text = "<b style='color:green;'>Playdar ready</b>";
            parseHash();
            setup_page();
        } else {
            text = "<b style='color:red;'>Playdar unavailable</b><br/>You need Playdar, the music content resolver, installed and running. See <a href=\"http://www.playdar.org/\">www.playdar.org</a>.";
        }
        $('playdar_stat').innerHTML = text;
    }
});

soundManager.url = '/static/soundmanager2_flash9.swf';
soundManager.flashVersion = 9;
soundManager.onload = function () {
    playdar.init();
};
playdar.soundmanager = soundManager;

var setup_page = function () {
    $('resultstbl').observe('click', function (event) {
        var target = event.element();
        if (target.match('a.play')) {
            event.stop();
            var sid = target.hash.substr(1);
            var sound = playdar.play_stream(sid);
            target.update((target.innerHTML == 'Play') ? 'Pause' : 'Play');
        }
    });
};

// make <TR> element
var build_result_row = function(result) {
    nicescore = result.score.toFixed(3);
    nicepref  = result.preference.toFixed(3);
    var td;
    var tr = document.createElement('tr');
    tr.id = result.sid;
    
    var play_text = "Play";
    var sound = playdar.register_stream(result.sid, {
        onfinish: function () {
            $('play' + this.sID).update(play_text);
        }
    });
    
    td = new Element('td').update(nicescore);
    tr.insert(td);
    
    td = new Element('td').setStyle({width: "50px"}).update(
        '<a href="#' + result.sid + '" id="play' + result.sid + '" class="play">'
         + play_text
         + '</a>'
     );
    tr.insert(td);
    
    td = new Element('td').update(result.artist);
    tr.insert(td);
    
    td = new Element('td').update(result.album);
    tr.insert(td);
    
    td = new Element('td').update(result.track);
    tr.insert(td);
    
    td = new Element('td').update(result.source);
    tr.insert(td);
    
    td = new Element('td').update(
        '<a href="' + playdar.get_stream_url(result.sid) + '">dl</a> '
        + '<small>('
        + Playdar.mmss(result.duration) + ', '
        + result.mimetype + ', '
        + (result.size/1000000).toFixed(1) + 'MB, '
        + result.bitrate + 'Kbps)</small>'
    );
    tr.insert(td);
    return tr;
};

// Insert results into the table in order of score:
var results_handler = function (response, final_answer) {
    var qsolved = '';
    if (final_answer) {
        qsolved = response.query.solved ? "solved" : "unsolved";
        qsolved = " (" + qsolved + ")";
        $('resolveProgress').hide();
    } else {
        $('resolveProgress').show();
    }
    $('numresultsspan').update("Found: " + response.results.length + qsolved);
    response.results.each(function (result) {
        if ($(result.sid)) {
            return;
        }
        var rows = $$('#resultstbl tr');
        // First result
        if (rows.length == 1) {
            $('resultstbl').down('tbody').insert(build_result_row(result));
            return;
        }
        // walk rows and insert in score-order
        for (k = 1; k < rows.length; k++) {
            var row = rows[k];
            var rowscore = parseFloat(row.down('td').innerHTML);
            if (rowscore < result.score) {
                row.insert({before: build_result_row(result)});
                break;
            }
        }
        // put at the end, lowest so far:
        if (k == rows.length) {
            $('resultstbl').down('tbody').insert(build_result_row(result));
        }
    });
};
playdar.register_results_handler(results_handler);

function clear_results() {
    $('numresultsspan').innerHTML = '0';
    // clear table of all but first(header) row
    var trs = $$('#resultstbl tr');
    var len = trs.length;
    for (var i = len-1; i > 0; i--) {
        $$('#resultstbl tr')[i].remove();
    }
}

function resolve(art, alb, trk) {
    window.location.hash = Object.toQueryString({
        artist: art,
        album: alb,
        track: trk
    });
    
    clear_results();
    playdar.resolve(art, alb, trk);
}

</script>
<h2>Search Demo</h2>
<!--#include virtual="demolist.html" -->
<div class="box" id="playdar_stat">Checking for local Playdar service...</div>

<form action="" onsubmit="resolve($('artist').value, $('album').value, $('track').value); return false;">
<fieldset>
<legend>Track Resolver - Specify artist and track name to (hopefully) find an exact match</legend>
artist:
<input type="text" id="artist" name="artist" value=""/>
<input type="hidden" id="album"  name="album" value=""/>
track:
<input type="text" id="track"  name="track" value=""/>
<input type="submit" value="Resolve!" id="resolveSubmit"/>
<img src="/static/spinner.gif" id="resolveProgress" style="display: none; vertical-align: middle; margin-left: 5px;" />
&nbsp; &nbsp;
</fieldset>
</form>

<h3>Search Results <span style="background-color:lightyellow; padding: 3px;" id="numresultsspan">0</span></h3>
<div id="resultsdiv">
    <span style="float:right; font-size:9px;">
        <a href="#" onclick="playdar.get_last_results(); return false;">re-check</a>
        <a href="#" onclick="clear_results(); return false;">clear</a>
    </span>
    <table style="width:100%; font-size:85%;" id="resultstbl"><tr style="font-weight: bold;">
        <td>Score</td> 
        <td style="width:25px;"> </td>
        <td>Artist</td>
        <td>Album</td>
        <td>Track</td>
        <td>Source</td>
        <td>Link</td>
    </tr></table>
    <br/>
</div>
</body>
</html>
