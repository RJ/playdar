<!--#set var="title" value="Playdar - hAudio Microformat Demo" --><!--#include virtual="../inc/header.html" -->

<script type="text/javascript">
// returns true if console.log available (firebug etc)
function clog(){ return typeof(window.console) != "undefined" ; }

var playdar = new Playdar({
    stat_complete: function (detected) {
        var text;
        if (detected) {
            text = "<b style='color:green;'>Playdar ready</b>";
        } else {
            text = "<b style='color:red;'>Playdar unavailable</b><br/>You need Playdar, the music content resolver, installed and running. See <a href=\"http://www.playdar.org/\">www.playdar.org</a>.";
        }
        $('playdar_stat').update(text);
    }
});
window.onload = function() {
    playdar.init();
};

</script>
<h2>hAudio Demo</h2>
<!--#include virtual="demolist.html" -->

<div class="box" id="playdar_stat">Checking for local Playdar service...</div>

<p>
This demo isn't really about microformats. It uses a super-simple hAudio implementation
to represent tracks, but you could write a custom parser to find elements on any site
that represent artist/track names.
</p>
<p>
<input type="button" value="Microformats Go!" onclick="go_microformats()" />
<ul>
    <li>
        <div class="haudio">
           <span class="contributor">Rick Astley</span> -
           <span class="fn">Never Gonna Give You Up</span>
        </div>
    </li>
    <li>
        <div class="haudio">
           <span class="contributor">Metallica</span> -
           <span class="fn">Enter Sandman</span> 
        </div>
    </li>
    <li>
        <div class="haudio">
           <span class="contributor">The Beatles</span> -
           <span class="fn">Yellow Submarine</span>
        </div>
    </li>
    <li>
        <div class="haudio">
           <span class="contributor">Guns N' Roses</span> -
           <span class="fn">Sweet Child O' Mine</span>
        </div>
    </li>
    <li>
        <div class="haudio">
           <span class="contributor">Joe Satriani</span> -
           <span class="fn">Surfing with the Alien</span> 
        </div>
    </li>
    <li>
        <div class="haudio">
           <span class="contributor">Massive Attack</span> - 
           <span class="fn">Angel</span>
        </div>
    </li>
    <li>
        <div class="haudio">
           <span class="contributor">Nightwish</span> -
           <span class="fn">Angels Fall First</span>
        </div>
    </li>
    <li>
        <div class="haudio">
           <span class="contributor">Big Bad Sun</span> -
           <span class="fn">Sweet Melissa</span> 
        </div>
        (this one is a a Magnatune artist)
    </li>
    <li>
        <div class="haudio">
           <span class="contributor">Dream Theatre</span> -
           <span class="fn">Pull Me Udner</span> 
        </div>
        (intentionally misspelled)
    </li>
    <li>
        <div class="haudio">
           <span class="contributor">Dire Straights</span> -
           <span class="fn">01 - sultans of swing</span> 
        </div>
        (intentionally misspelled)
    </li>

</ul>
</p>

<script type="text/javascript">

function go_microformats() {
    if (!playdar.check_stat()) {
        alert("Playdar not detected. Start it, then refresh and try again");
        return;
    }
    var mkstatuselem = function (id) {
        var d = document.createElement('span');
        d.id = id;
        d.className = 'playdar_searching';
        d.innerHTML="&nbsp; &nbsp;";
        return d;
    };
    // create a custom playdar callback that will handle results for this query:
    var results_handler = function (response, finalanswer) {
        if (clog()) console.log("result_callback: " + response.qid + " finalanswer: " + finalanswer + " num results = " + response.results.length);
        if (response.results.length) {
            // generate tooltip with details:
            var tt = "Sources: ";
            for (var k = 0; k < response.results.length; ++k) {
                var r = response.results[k];
                tt += "<b>"+r.source + "</b><small> (<a href=\""+playdar.get_stream_url(response.results[k].sid)+"\">" + r.bitrate + "k, " + Playdar.mmss(r.duration) + "</a>)</small> ";
            }
            // update status element:
            $(response.qid).className = 'playdar_found';
            var swfstr = "<object height=\"17\" width=\"17\"><embed src=\"/static/player.swf?&song_url=" + playdar.get_stream_url(response.results[0].sid) + "\" height=\"17\" width=\"17\"></embed></object>";
            $(response.qid).innerHTML = swfstr + " <a href=\"#\" title=\"Toggle source info\" onclick=\"$('info-"+response.qid+"').toggle(); return false;\">" + response.results.length + "</a> <div id=\"info-"+response.qid+"\" style=\"display:none; border:1px solid grey;\">" + tt + "</div>" ;
        } else if (finalanswer) {
            $(response.qid).className = 'playdar_notfound';
            $(response.qid).innerHTML = ':(';
        }
    };
    playdar.register_results_handler(results_handler);
    
    var divs = $$('div.haudio');
    for (var i = 0; i < divs.length; ++i) {
        var artist  = divs[i].select('span.contributor')[0].innerHTML.replace(/^\s+|\s+$/g, '');
        var track   = divs[i].select('span.fn')[0].innerHTML.replace(/^\s+|\s+$/g, '');
        var uuid = Playdar.generate_uuid();
        // add a "searching..." status :
        divs[i].appendChild(mkstatuselem(uuid)); 
        playdar.resolve(artist, "", track, uuid);
        if (clog()) console.log("dispatched " + uuid + " " + artist + " - " + track);
    }
}
</script>
</body>
</html>
